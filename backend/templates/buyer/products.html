{% extends "base.html" %}

{% block title %}Products - Market Window{% endblock %}

{% block content %}
{% set selected_category_id = request.args.get('category_id', '') %}
{% set selected_shop_id = request.args.get('shop_id', '') %}
<div class="container py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="fw-bold">Browse Products</h1>
            <p class="text-muted">Real inventory from verified shops</p>
        </div>
    </div>

    <div x-data="{ showExtraCriteria: false }" class="mb-4">
        <div class="row g-3 align-items-center">
            <div class="col-md-8">
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input
                        type="text"
                        class="form-control"
                        name="search"
                        placeholder="Search product or shop..."
                        hx-get="{{ url_for('buyer_bp.browse_products') }}"
                        hx-trigger="keyup changed delay:400ms"
                        hx-target="#products-container"
                        hx-include="[name='category_id'],[name='shop_id'],[name='sort_by'],[name='in_stock'],[name='min_price'],[name='max_price']"
                        hx-swap="innerHTML"
                    >
                </div>
            </div>
            <div class="col-md-4 text-md-end">
                <button
                    type="button"
                    class="btn btn-outline-secondary btn-sm"
                    @click="showExtraCriteria = !showExtraCriteria"
                    :aria-expanded="showExtraCriteria.toString()"
                >
                    Extra Search Criteria
                    <i class="bi ms-1" :class="showExtraCriteria ? 'bi-caret-up-fill' : 'bi-caret-down-fill'"></i>
                </button>
            </div>
        </div>

        <div class="row g-3 mt-1" x-show="showExtraCriteria" x-transition>
            <div class="col-md-4">
                <select
                    class="form-select"
                    name="category_id"
                    hx-get="{{ url_for('buyer_bp.browse_products') }}"
                    hx-trigger="change"
                    hx-target="#products-container"
                    hx-include="[name='search'],[name='shop_id'],[name='sort_by'],[name='in_stock'],[name='min_price'],[name='max_price']"
                    hx-swap="innerHTML"
                >
                    <option value="">All Categories</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}" {% if selected_category_id and selected_category_id|int == category.id %}selected{% endif %}>{{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <input
                    type="number"
                    class="form-control"
                    name="min_price"
                    placeholder="Min price"
                    min="0"
                    step="0.01"
                    hx-get="{{ url_for('buyer_bp.browse_products') }}"
                    hx-trigger="change"
                    hx-target="#products-container"
                    hx-include="[name='search'],[name='category_id'],[name='shop_id'],[name='sort_by'],[name='in_stock'],[name='max_price']"
                    hx-swap="innerHTML"
                >
            </div>
            <div class="col-md-3">
                <input
                    type="number"
                    class="form-control"
                    name="max_price"
                    placeholder="Max price"
                    min="0"
                    step="0.01"
                    hx-get="{{ url_for('buyer_bp.browse_products') }}"
                    hx-trigger="change"
                    hx-target="#products-container"
                    hx-include="[name='search'],[name='category_id'],[name='shop_id'],[name='sort_by'],[name='in_stock'],[name='min_price']"
                    hx-swap="innerHTML"
                >
            </div>
            <div class="col-md-2 d-flex align-items-center">
                <div class="form-check mt-2">
                    <input
                        class="form-check-input"
                        type="checkbox"
                        name="in_stock"
                        value="true"
                        id="in-stock-only"
                        hx-get="{{ url_for('buyer_bp.browse_products') }}"
                        hx-trigger="change"
                        hx-target="#products-container"
                        hx-include="[name='search'],[name='category_id'],[name='shop_id'],[name='sort_by'],[name='min_price'],[name='max_price']"
                        hx-swap="innerHTML"
                    >
                    <label class="form-check-label small" for="in-stock-only">Stock</label>
                </div>
            </div>
            <div class="col-md-12 col-lg-4">
                <select
                    class="form-select"
                    name="sort_by"
                    hx-get="{{ url_for('buyer_bp.browse_products') }}"
                    hx-trigger="change"
                    hx-target="#products-container"
                    hx-include="[name='search'],[name='category_id'],[name='shop_id'],[name='in_stock'],[name='min_price'],[name='max_price']"
                    hx-swap="innerHTML"
                >
                    <option value="name">Sort: Name</option>
                    <option value="newest">Sort: Newest</option>
                    <option value="price">Sort: Price Low-High</option>
                    <option value="price_desc">Sort: Price High-Low</option>
                    <option value="stock">Sort: Stock</option>
                </select>
            </div>
        </div>
    </div>

    <input type="hidden" name="shop_id" value="{{ selected_shop_id }}">

    <div
        class="row g-4"
        id="products-container"
        hx-get="{{ url_for('buyer_bp.browse_products', category_id=selected_category_id, shop_id=selected_shop_id) if selected_category_id or selected_shop_id else url_for('buyer_bp.browse_products') }}"
        hx-trigger="load"
        hx-target="#products-container"
        hx-swap="innerHTML"
    >
        <div class="col-12 text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 text-mw">Loading products...</p>
        </div>
    </div>

    <div class="text-center mt-4" id="product-load-more-container"></div>
</div>
{% endblock %}
